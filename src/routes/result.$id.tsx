import { createFileRoute, Link, useNavigate } from '@tanstack/react-router'
import { useEffect, useState } from 'react'

export const Route = createFileRoute('/result/$id')({
  component: ResultComponent,
})

function DownloadIcon() {
  return (
    <svg
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      style={{ marginRight: '0.5rem' }}
    >
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
      <polyline points="7 10 12 15 17 10" />
      <line x1="12" y1="15" x2="12" y2="3" />
    </svg>
  )
}

function ResultComponent() {
  const { id } = Route.useParams()
  const navigate = useNavigate()
  const [imageUrl, setImageUrl] = useState<string | null>(null)
  const [responseText, setResponseText] = useState<string>('')
  const [model, setModel] = useState<string>('')
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const storedData = sessionStorage.getItem(`result-${id}`)
    if (storedData) {
      try {
        const { imageUrl, text, model } = JSON.parse(storedData)
        setImageUrl(imageUrl)
        setResponseText(text || '')
        setModel(model || '')
        setLoading(false)
        // Clean up sessionStorage after retrieving
        sessionStorage.removeItem(`result-${id}`)
      } catch (e) {
        console.error('Failed to parse stored result:', e)
        navigate({ to: '/' })
      }
    } else {
      // No stored data, redirect back to home
      navigate({ to: '/' })
    }
  }, [id, navigate])

  const handleDownload = () => {
    if (!imageUrl) return

    if (imageUrl.startsWith('data:')) {
      const link = document.createElement('a')
      link.href = imageUrl
      link.download = `restored-${id}.png`
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
    }
  }

  if (loading) {
    return (
      <main>
        <h1>Loading...</h1>
        <div className="card">
          <div className="spinner"></div>
        </div>
      </main>
    )
  }

  return (
    <main>
      <h1>Your Restored Photo</h1>
      <div className="divider"></div>

      <div className="card">
        <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem', alignItems: 'center' }}>
          {imageUrl && (
            <img
              src={imageUrl}
              alt="Restored"
              className="result-image"
            />
          )}

          {responseText && (
            <p className="response-text">
              {responseText}
            </p>
          )}

          {model && (
            <p className="meta-text">
              Generated by: {model}
            </p>
          )}

          <div className="button-group" style={{ marginTop: '0.5rem' }}>
            <button onClick={handleDownload} className="gold">
              <span style={{ display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                <DownloadIcon />
                Download Photo
              </span>
            </button>
            <Link to="/">
              <button className="secondary">
                Restore Another
              </button>
            </Link>
          </div>
        </div>
      </div>
    </main>
  )
}
