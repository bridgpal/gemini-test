import { createFileRoute, Link, useNavigate } from '@tanstack/react-router'
import { useEffect, useState } from 'react'

export const Route = createFileRoute('/result/$id')({
  component: ResultComponent,
})

function ResultComponent() {
  const { id } = Route.useParams()
  const navigate = useNavigate()
  const [imageUrl, setImageUrl] = useState<string | null>(null)
  const [responseText, setResponseText] = useState<string>('')
  const [model, setModel] = useState<string>('')
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    const storedData = sessionStorage.getItem(`result-${id}`)
    if (storedData) {
      try {
        const { imageUrl, text, model } = JSON.parse(storedData)
        setImageUrl(imageUrl)
        setResponseText(text || '')
        setModel(model || '')
        setLoading(false)
        // Clean up sessionStorage after retrieving
        sessionStorage.removeItem(`result-${id}`)
      } catch (e) {
        console.error('Failed to parse stored result:', e)
        navigate({ to: '/' })
      }
    } else {
      // No stored data, redirect back to home
      navigate({ to: '/' })
    }
  }, [id, navigate])

  const handleDownload = () => {
    if (!imageUrl) return

    if (imageUrl.startsWith('data:')) {
      const link = document.createElement('a')
      link.href = imageUrl
      link.download = `restored-${id}.png`
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
    }
  }

  if (loading) {
    return (
      <main>
        <h1>Loading...</h1>
        <div className="card">
          <div className="spinner"></div>
        </div>
      </main>
    )
  }

  return (
    <main>
      <h1>Your Restored Photo</h1>
      <div className="card">
        <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem', alignItems: 'center' }}>
          {imageUrl && (
            <img
              src={imageUrl}
              alt="Restored"
              className="result-image"
            />
          )}

          {responseText && (
            <p style={{ color: '#666', fontSize: '0.95rem', textAlign: 'center', maxWidth: '500px' }}>
              {responseText}
            </p>
          )}

          {model && (
            <p style={{ color: '#888', fontSize: '0.85rem' }}>
              Generated by: {model}
            </p>
          )}

          <div style={{ display: 'flex', gap: '1rem' }}>
            <button onClick={handleDownload}>
              Download Photo
            </button>
            <Link to="/">
              <button style={{ backgroundColor: 'var(--color-sage)', color: '#333' }}>
                Restore Another
              </button>
            </Link>
          </div>
        </div>
      </div>
    </main>
  )
}
